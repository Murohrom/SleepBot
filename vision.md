# Техническое видение проекта SleepBot

## Содержание
1. [Технологии](#технологии)
2. [Принципы разработки](#принципы-разработки)
3. [Структура проекта](#структура-проекта)
4. [Архитектура проекта](#архитектура-проекта)
5. [Модель данных](#модель-данных)
6. [Работа с LLM](#работа-с-llm)
7. [Мониторинг](#мониторинг)
8. [Сценарии работы](#сценарии-работы)
9. [Деплой](#деплой)
10. [Подход к конфигурированию](#подход-к-конфигурированию)
11. [Подход к логгированию](#подход-к-логгированию)

---

## Технологии

### Основной стек
- **Язык программирования**: Python 3.11+
- **Telegram Bot API**: aiogram 3.x
- **LLM интеграция**: OpenRouter через OpenAI client
- **Хранение данных**: Python dict/list (в памяти)
- **Управление зависимостями**: uv
- **Тестирование**: pytest
- **Контейнеризация**: Docker
- **Автоматизация**: Make

### Дополнительные инструменты
- **Линтинг**: ruff
- **Форматирование**: black
- **Типизация**: mypy
- **Документация**: docstrings + README

## Принципы разработки

### Основные принципы
- **KISS (Keep It Simple, Stupid)**: Минимальная сложность, только необходимый функционал
- **Функциональный подход**: Архитектура на основе функций без ООП
- **Single Responsibility**: Каждая функция отвечает за одну задачу
- **Fail Fast**: Быстрое обнаружение и обработка ошибок
- **Explicit over Implicit**: Явные решения вместо магических

### Подход к проектированию
- **Функциональная архитектура**: Модули как наборы функций, а не классов
- **Чистые функции**: Минимизация побочных эффектов
- **Простота**: Избегание абстракций и паттернов, которые усложняют код
- **Прямолинейность**: Понятный поток выполнения без сложных зависимостей

## Структура проекта

```
SleepBot/
├── src/
│   ├── __init__.py
│   ├── main.py              # Точка входа
│   ├── bot/                 # Telegram бот
│   │   ├── __init__.py
│   │   ├── handlers.py      # Обработчики сообщений
│   │   └── utils.py         # Утилиты для бота
│   ├── llm/                 # Работа с LLM
│   │   ├── __init__.py
│   │   ├── client.py        # Клиент OpenRouter
│   │   └── prompts.py       # Промпты
│   ├── storage/             # Хранение данных
│   │   ├── __init__.py
│   │   └── memory.py        # In-memory хранилище
│   └── config/              # Конфигурация
│       ├── __init__.py
│       └── settings.py      # Настройки
├── tests/                   # Тесты
├── doc/                     # Документация
├── docker/                  # Docker файлы
├── Makefile                 # Автоматизация
├── pyproject.toml           # Зависимости (uv)
├── Dockerfile
└── README.md
```

### Принципы организации
- **Модульность**: Каждый модуль отвечает за свою область
- **Простота**: Минимальное количество файлов и папок
- **Понятность**: Понятные названия файлов и папок
- **Масштабируемость**: Легко добавлять новые функции

## Архитектура проекта

### Основные компоненты
- **Telegram Bot** - точка входа, обработка сообщений
- **LLM Client** - взаимодействие с OpenRouter
- **Storage** - in-memory хранение диалогов
- **Config** - настройки приложения

### Поток данных
```
Telegram → Bot Handler → LLM Client → Storage → Response
```

### Принципы архитектуры
- **Функциональный подход**: Простые функции с передачей данных через параметры
- **Централизованная обработка ошибок**: Единая точка обработки исключений
- **Синхронная обработка**: Простота реализации без асинхронности
- **Один экземпляр**: Один экземпляр бота для простоты
- **In-memory состояние**: Хранение диалогов в памяти процесса

## Модель данных

### Основные структуры данных
```python
# Пользователь
User = {
    "user_id": int,
    "username": str,
    "first_name": str,
    "last_name": str,
    "created_at": datetime,
    "last_activity": datetime
}

# Сообщение в диалоге
Message = {
    "id": str,
    "user_id": int,
    "content": str,
    "timestamp": datetime,
    "role": str  # "system", "user", "assistant"
}

# Диалог пользователя
Conversation = {
    "user_id": int,
    "messages": List[Message],
    "started_at": datetime,
    "last_activity": datetime
}
```

### Принципы хранения данных
- **In-memory хранение**: Все данные хранятся в памяти процесса
- **Без ограничений**: Нет лимитов на количество сообщений в диалоге
- **Без автоочистки**: Данные сохраняются до перезапуска бота
- **Системное сообщение**: Первое сообщение в диалоге всегда с ролью "system"
- **Простота**: Использование стандартных Python структур (dict, list)
- **Прямолинейность**: Минимальная сложность без дополнительных абстракций

## Работа с LLM

### Основные компоненты
- **OpenAI Client** - для работы с OpenRouter API
- **Промпты** - системные промпты для анализа снов
- **Контекст диалога** - передача истории сообщений

### Принципы работы с LLM
- **Модель**: GPT-4 через OpenRouter
- **Без ограничений контекста**: Передача всех сообщений диалога
- **Без ограничений токенов**: Не отслеживаем использование токенов
- **Один системный промпт**: Единый промпт с инструкциями для анализа снов
- **Простая обработка ошибок**: Fallback сообщение при ошибках API

### Поток работы
1. Получение сообщения от пользователя
2. Добавление в историю диалога
3. Формирование контекста (все сообщения диалога)
4. Отправка запроса к LLM с системным промптом
5. Получение ответа и отправка пользователю
6. Сохранение ответа в историю диалога

## Мониторинг

### Основные метрики
- Количество активных пользователей
- Количество сообщений в день
- Время ответа LLM
- Ошибки API

### Принципы мониторинга
- **Простое логирование**: Все метрики записываются в лог-файл
- **Базовые метрики**: Минимальный набор для понимания работы бота
- **Без алертов**: Нет автоматических уведомлений о проблемах
- **Без дашборда**: Статистика доступна только через логи
- **Уровень INFO**: Основные события логируются на уровне INFO

## Сценарии работы

### Основные сценарии
1. **Начало диалога** - приветствие и инструкции при команде /start
2. **Анализ сна** - получение описания сна и анализ через LLM
3. **Уточняющие вопросы** - запрос дополнительной информации от LLM
4. **Предложение услуг** - рекомендации на основе анализа сна
5. **Обработка ошибок** - fallback при проблемах с LLM API

### Команды бота
- **/start** - начало диалога, приветствие
- **/help** - справка по использованию бота
- **/reset** - сброс диалога, начало нового разговора

### Принципы работы
- **Простое приветствие**: Краткое описание возможностей при /start
- **Контекст диалога**: Сохраняется до команды /reset
- **Простые ошибки**: Понятные сообщения при проблемах с API
- **Естественное общение**: Бот отвечает как обычный собеседник

## Деплой

### Основные компоненты
- **Docker контейнер** - изолированное окружение
- **Make команды** - автоматизация сборки и запуска
- **Переменные окружения** - конфигурация через .env

### Принципы деплоя
- **Один контейнер**: Простое развертывание без оркестрации
- **Make автоматизация**: Команды для сборки, запуска, остановки
- **Переменные окружения**: Токен бота, API ключ OpenRouter в .env
- **Локальный запуск**: Docker контейнер на локальной машине
- **Без бэкапов**: Данные in-memory, не требуют резервного копирования

### Команды Make
- `make build` - сборка Docker образа
- `make run` - запуск контейнера
- `make stop` - остановка контейнера
- `make logs` - просмотр логов
- `make restart` - перезапуск контейнера

## Подход к конфигурированию

### Основные принципы
- **Файл .env** - основной способ конфигурации
- **Переменные окружения** - для Docker контейнера
- **Валидация** - проверка обязательных переменных при запуске

### Переменные окружения
- `TELEGRAM_BOT_TOKEN` - токен Telegram бота
- `OPENROUTER_API_KEY` - API ключ OpenRouter
- `LOG_LEVEL` - уровень логирования (INFO, DEBUG, ERROR)

### Принципы конфигурирования
- **Все конфиги в .env**: Единый файл для всех настроек
- **Простая валидация**: Проверка наличия обязательных переменных
- **Без значений по умолчанию**: Все настройки должны быть явно заданы
- **Локальная разработка**: .env файл для разработки на локальной машине
- **Docker окружение**: Переменные окружения для контейнера
- **Без секретов**: Все секреты передаются через переменные окружения

## Подход к логгированию

### Основные принципы
- **Стандартный logging** - встроенный модуль Python
- **Файловое логирование** - логи в файл
- **Ключевые события** - только важные события

### Логируемые события
- **Запросы и ответы LLM** - для анализа работы модели
- **Приветствие и знакомство** - новые пользователи
- **Вопросы о компании** - взаимодействие с услугами

### Принципы логирования
- **Уровень INFO**: Основные события
- **Простой текстовый формат**: Читаемые логи
- **Без ротации**: Простота управления
- **Настройка через код**: Минимальная сложность
- **Без избыточности**: Только необходимые данные
